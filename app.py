# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1w40BE6OIRCYWduOBMN_tjMTAlWLyDOXy
"""

import streamlit as st
import pandas as pd
import joblib
import tempfile
import os
from typing import Optional, Tuple

st.set_page_config(page_title="é¢¨éšªåˆ†æ•¸é æ¸¬å™¨ï¼ˆCox æ¨¡å‹ï¼‰", layout="centered")


# -------------------------
# custom lossï¼ˆå»¶é² import tensorflowï¼‰
# å®šç¾©æ™‚ä¸è¦åœ¨ module level ç›´æ¥ import tensorflowï¼Œ
# è€Œæ˜¯åœ¨ function å…§éƒ¨ importï¼Œè®“é€™å€‹å‡½æ•¸å¯è¢«å‚³çµ¦ load_model çš„ custom_objectsã€‚
# -------------------------
def cox_ph_loss(y_true, y_pred):
    import tensorflow as tf  # lazy import
    events = tf.cast(y_true[:, 0], tf.float32)
    times = tf.cast(y_true[:, 1], tf.float32)
    risk = tf.squeeze(y_pred, axis=-1)

    order = tf.argsort(times, direction='DESCENDING')
    risk_ordered = tf.gather(risk, order)
    event_ordered = tf.gather(events, order)

    shift = tf.reduce_max(risk_ordered)
    exp_risk_shifted = tf.exp(risk_ordered - shift)

    cumsum_exp = tf.cumsum(exp_risk_shifted)
    log_cumsum_exp = tf.math.log(cumsum_exp) + shift

    log_lik = risk_ordered - log_cumsum_exp
    log_lik_event = tf.boolean_mask(log_lik, event_ordered > 0)
    neg_mean_log_lik = -tf.reduce_mean(log_lik_event)
    return neg_mean_log_lik


# -------------------------
# features åˆ—è¡¨ï¼ˆèˆ‡ UI é¸é …ï¼‰
# -------------------------
continuous_vars = ['age', 'ca199', 'size']
categorical_vars = ['sex', 'grade', 'margin', 'LVI', 'PNI', 'pT', 'pN',
                    'cysticneoplasm', 'neoadjuvant', 'opmethod']
all_model_features = continuous_vars + categorical_vars

sex_opts = ["M", "F"]
grade_opts = ["G1", "G2", "G3"]
yn_opts = ["0", "1", "No", "Yes"]
pT_opts = ["T1", "T2", "T3", "T4"]
pN_opts = ["N0", "N1", "N2", "N3"]
op_opts = ["Open", "Lap", "Robot", "Other"]


# -------------------------
# helper: æŠŠ bytes å¯«æˆæš«å­˜æª”ä¸¦å›å‚³è·¯å¾‘
# -------------------------
def _write_bytes_to_tempfile(b: bytes, suffix: str) -> str:
    tmp = tempfile.NamedTemporaryFile(delete=False, suffix=suffix)
    try:
        tmp.write(b)
        tmp.flush()
        return tmp.name
    finally:
        tmp.close()


# -------------------------
# è¼‰å…¥å™¨ï¼šæ¥å— model_bytes èˆ‡ preproc_bytesï¼ˆå¯è¢« st.cache_resource å¿«å–ï¼‰
# è¿”å› (model, preproc, message)
# -------------------------
@st.cache_resource
def load_resources_from_bytes(model_bytes: bytes, preproc_bytes: bytes) -> Tuple[Optional[object], Optional[object], str]:
    model_path = None
    preproc_path = None
    try:
        # æŠŠ bytes å¯«æˆæš«å­˜æª”ï¼ˆload_model / joblib éœ€è¦ file pathï¼‰
        model_path = _write_bytes_to_tempfile(model_bytes, suffix=".h5")
        preproc_path = _write_bytes_to_tempfile(preproc_bytes, suffix=".pkl")

        # å»¶é² import tensorflow ä¸¦è¼‰å…¥ model
        try:
            import tensorflow as tf  # lazy import
            from tensorflow.keras.models import load_model
        except Exception as e:
            return None, None, f"âŒ ç„¡æ³• import TensorFlowï¼š{e}. è‹¥è¦åœ¨æ­¤ç’°å¢ƒè¼‰å…¥æ¨¡å‹ï¼Œè«‹åœ¨ requirements.txt æŒ‡å®šå¯ç”¨çš„ tensorflow-cpu ç‰ˆæœ¬ã€‚"

        # è¼‰å…¥ model èˆ‡ preprocessor
        model = load_model(model_path, custom_objects={'cox_ph_loss': cox_ph_loss})
        preproc = joblib.load(preproc_path)

        return model, preproc, "âœ… æ¨¡å‹èˆ‡ Preprocessor è¼‰å…¥æˆåŠŸ"
    except Exception as e:
        return None, None, f"âŒ è¼‰å…¥å¤±æ•—ï¼š{e}"
    finally:
        # å˜—è©¦åˆªé™¤æš«å­˜æª”ï¼ˆè¼‰å…¥å®Œæˆå¾Œé€šå¸¸å¯åˆªï¼‰
        for p in (model_path, preproc_path):
            try:
                if p and os.path.exists(p):
                    os.remove(p)
            except Exception:
                pass


# -------------------------
# predict å‡½å¼
# -------------------------
def predict_once(model, preproc, input_data: dict):
    df = pd.DataFrame([input_data], columns=all_model_features)
    for col in continuous_vars:
        df[col] = pd.to_numeric(df[col], errors='coerce')
    X = preproc.transform(df)
    # model.predict å›å‚³ shape (1,1) æˆ– (1,) å–ç¬¬ä¸€å€‹å€¼
    risk_arr = model.predict(X, verbose=0)
    # reshape å®‰å…¨è™•ç†
    try:
        risk = float(risk_arr.reshape(-1)[0])
    except Exception:
        # è‹¥è¼¸å‡ºç‚ºç´”æ¨™é‡
        risk = float(risk_arr[0])
    return risk


# -------------------------
# Streamlit UI
# -------------------------
st.title("ğŸ§® é¢¨éšªåˆ†æ•¸é æ¸¬å™¨ï¼ˆCox æ¨¡å‹ï¼‰")
st.write("èªªæ˜ï¼šè«‹ä¸Šå‚³ç”±ä½ ä¿¡ä»»ä¾†æºç”¢ç”Ÿçš„ `model.h5`ï¼ˆKerasï¼‰èˆ‡ `preprocessor.pkl`ï¼ˆjoblibï¼‰ã€‚ä¸Šå‚³å¾ŒæŒ‰ã€Œè¨ˆç®— Risk Scoreã€ã€‚")

st.subheader("1. è¼‰å…¥æ¨¡å‹èˆ‡å‰è™•ç†å™¨ï¼ˆä¸Šå‚³ï¼‰")
col1, col2 = st.columns(2)
with col1:
    model_file = st.file_uploader("ä¸Šå‚³ model.h5", type=["h5"])
with col2:
    preproc_file = st.file_uploader("ä¸Šå‚³ preprocessor.pkl", type=["pkl"])

model = None
preproc = None

if model_file is not None and preproc_file is not None:
    # è®€ bytesï¼ˆè‹¥ä¹‹å‰ read éï¼Œè«‹å…ˆ seek(0)ï¼‰
    try:
        model_file.seek(0)
        preproc_file.seek(0)
        model_bytes = model_file.read()
        preproc_bytes = preproc_file.read()
    except Exception as e:
        st.error(f"è®€å–ä¸Šå‚³æª”æ¡ˆå¤±æ•—ï¼š{e}")
        model_bytes = preproc_bytes = None

    if model_bytes and preproc_bytes:
        with st.spinner("è¼‰å…¥æ¨¡å‹èˆ‡å‰è™•ç†å™¨...ï¼ˆé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼‰"):
            model, preproc, msg = load_resources_from_bytes(model_bytes, preproc_bytes)
            if model is None or preproc is None:
                st.error(msg)
            else:
                st.success(msg)
else:
    st.info("è«‹åŒæ™‚ä¸Šå‚³ model.h5 èˆ‡ preprocessor.pklï¼ˆå…©è€…çš†éœ€ï¼‰ã€‚\n\næç¤ºï¼šè‹¥ä¸æƒ³åœ¨ Streamlit Cloud å®‰è£ TensorFlowï¼Œå¯æŠŠæ¨¡å‹æ”¾åˆ°å¤–éƒ¨æœå‹™ä¸¦æ”¹ç”¨é ç«¯ inferenceã€‚")

st.subheader("2. è¼¸å…¥ Features")
with st.form("prediction_form"):
    age = st.number_input("Age", value=60, step=1)
    ca199 = st.number_input("CA199", value=35.0, format="%.2f")
    size = st.number_input("Tumor Size (cm)", value=2.5, format="%.2f")

    sex = st.selectbox("Sex", sex_opts)
    grade = st.selectbox("Grade", grade_opts)
    margin = st.selectbox("Margin", yn_opts)
    LVI = st.selectbox("LVI", yn_opts)
    PNI = st.selectbox("PNI", yn_opts)
    pT = st.selectbox("pT", pT_opts)
    pN = st.selectbox("pN", pN_opts)
    cysticneoplasm = st.selectbox("Cystic Neoplasm", yn_opts)
    neoadjuvant = st.selectbox("Neoadjuvant", yn_opts)
    opmethod = st.selectbox("Surgical Method", op_opts)

    submitted = st.form_submit_button("è¨ˆç®— Risk Score")

    if submitted:
        if model is None or preproc is None:
            st.warning("è«‹å…ˆä¸Šå‚³ä¸¦æˆåŠŸè¼‰å…¥æ¨¡å‹èˆ‡å‰è™•ç†å™¨ï¼ˆmodel.h5 èˆ‡ preprocessor.pklï¼‰ã€‚")
        else:
            input_data = {
                'age': age,
                'ca199': ca199,
                'size': size,
                'sex': sex,
                'grade': grade,
                'margin': margin,
                'LVI': LVI,
                'PNI': PNI,
                'pT': pT,
                'pN': pN,
                'cysticneoplasm': cysticneoplasm,
                'neoadjuvant': neoadjuvant,
                'opmethod': opmethod,
            }
            try:
                with st.spinner("è¨ˆç®—ä¸­..."):
                    score = predict_once(model, preproc, input_data)
                st.success(f"ğŸ’¡ é æ¸¬é¢¨éšªåˆ†æ•¸ï¼š`{score:.6f}`ï¼ˆåˆ†æ•¸è¶Šé«˜é¢¨éšªè¶Šé«˜ï¼‰")
            except Exception as e:
                st.error(f"é æ¸¬æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")

# -------------------------
# é¡å¤–ï¼šé¡¯ç¤ºå·²è¼‰å…¥çš„ model / preproc quick infoï¼ˆæ–¹ä¾¿ debugï¼‰
# -------------------------
if model is not None:
    st.write("**æ¨¡å‹å·²è¼‰å…¥ï¼ˆè¨˜æ†¶é«”ï¼‰**")
if preproc is not None:
    st.write("**Preprocessor å·²è¼‰å…¥ï¼ˆè¨˜æ†¶é«”ï¼‰**")